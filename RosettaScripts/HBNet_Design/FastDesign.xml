<ROSETTASCRIPTS>

    <SCOREFXNS>
        <ScoreFunction name="sfxn" weights="ref2015"/>
        <ScoreFunction name="sfxn_cst" weights="ref2015_cst"/>
    </SCOREFXNS>

    <RESIDUE_SELECTORS>
        <!--Select Ligand-->
        <Chain name="ligand" chains="X"/>
        <!--Select residues built in by HBNet-->
        <ResiduePDBInfoHasLabel name="hbnet_residues" property="HBNet"/>
        <!--Indicies for matched motif residues, pass in from command line -->
        <Index name="motif_residues" resnums="%%motif_residues%%"/>
        <!--Select all residues that aren't design positions-->
        <Not name="outside_design_shell">
            <!--Select design positions from JSON generated by Prep-HB_Design.py -->
            <Index name="design_positions" resnums="%%design_positions%%" />
        </Not>
        <!--Select all residues that will not be designed-->
        <Or name="not_designed" selectors="motif_residues,outside_design_shell"/>
    </RESIDUE_SELECTORS>

    <TASKOPERATIONS>
        <!--Get flags from command line: -ex1 -ex2 -use_input_sc -flip_HNQ, -no_optH false -->
        <InitializeFromCommandline name="init"/>
        <!--Set HBNet residues to repack only, allows wiggle room within constraint tolerances-->
        <OperateOnResidueSubset name="hbnet_task" selector="hbnet_residues">
           <RestrictToRepackingRLT/>
        </OperateOnResidueSubset>
        <!--Set motif residues to repack only-->
        <OperateOnResidueSubset name="motif_task" selector="motif_residues">
           <RestrictToRepackingRLT/>
        </OperateOnResidueSubset>
        <!--Set ligand to no repack or design-->
        <OperateOnResidueSubset name="fixlig" selector="ligand">
            <PreventRepackingRLT/>
        </OperateOnResidueSubset>
        <!--Set non-designed positions to no repack or design-->
        <OperateOnResidueSubset name="fixed_outside_shell" selector="not_designed">
            <PreventRepackingRLT/>
        </OperateOnResidueSubset>
        <!--Go HAM on extra rotamers-->
        <ExtraRotamersGeneric name="extra_rots" ex1="True" ex2="True" ex3="True" ex1_sample_level="1" ex2_sample_level="1"
                              ex3_sample_level="1" extrachi_cutoff="0"/>
        <!--Include current rotamers in packer-->
        <IncludeCurrent name="ic" />
    </TASKOPERATIONS>

    <FILTERS>
        <!--Filter out designs where ligand-protein interaction energy is more than 0-->
        <LigInterfaceEnergy name="interfE" scorefxn="sfxn" energy_cutoff="0.0" confidence="1" />
        <!--Filter out designs where % shape complentarity with ligand is less thn 0.75-->
        <ShapeComplementarity name="Lig_ShapeC" min_sc="0.75" min_interface="0" verbose="0" quick="0" jump="1" confidence="1"/>
    </FILTERS>

    <MOVERS>
        <!--Fast Design-->
        <FastDesign name="FastDesign" scorefxn="sfxn_cst" clear_designable_residues="False" ramp_down_constraints="False"
                    repeats="2" task_operations="ic,fixlig,hbnet_task,motif_task,fixed_outside_shell,init">
        </FastDesign>
        <!--Generic MC... It seems like this is just a filtering step without drift=True?-->
        <GenericMonteCarlo name="GM_design" mover_name="FastDesign" filter_name="interfE" trials="10" progress_file="MC_progess_design.txt"
                           bolz_rank="True" recover_low="True" preapply="False" drift="False" sample_type="low" temperature="0.03">
            <Filters>
                <AND filter_name="interfE" sample_type="low" temperature="1"/>
                <AND filter_name="Lig_ShapeC" sample_type="high" temperature="0.1"/>
            </Filters>
        </GenericMonteCarlo>
    </MOVERS>

    <PROTOCOLS>
        <Add mover_name="GM_design"/>
    </PROTOCOLS>

</ROSETTASCRIPTS>